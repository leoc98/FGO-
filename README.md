# Fate Grand Order FGO自动战斗脚本v0.1



## 简介

此项目为国服命运冠位指定脚本，使用opencv图像识别进行按钮分析。

目前实现的功能有

1. 根据图片自动选择助战角色，若角色不存在，会自动进行助战刷新，直到找到；
2. 根据设定流程进行宝具洗地；
3. 战斗结束后连续出击重复刷本，若体力不足，则默认先金后银苹果补充体力；

*仅支持单开，多开需要自行指定adb连接端口


## 环境

需要安装下列python包:

```
pip install opencv-python==3.* -i https://pypi.tuna.tsinghua.edu.cn/simple/
pip install uiautomator2 -i https://mirrors.aliyun.com/pypi/simple/
```

windows端需要adb工具，在adb文件夹，请自行手动添加到path中

若使用模拟器,则需要将模拟器设置为桥接模式.  具体参考这个项目(https://github.com/Jiahonzheng/JGM-Automator)

默认使用雷电模拟器4以下（不包含）的版本，4及以上版本的雷电模拟器可能会找不到端口

**重要：模拟器分辨率要求540*960**

## 配置方式

1. 使用文本编辑器，打开文件目录下的 ***main.py*** 进行编辑；

2. 打开模拟器在助战界面对所需的助战进行截图，并保存在 ***img/*** 目录下（不建议完整截图，建议只截取助战头像的不会闪动的部份，即加不包括加成物品的部分（参考 ***img/cba_zhuzhan.jpg***）

3. 将 ***main.py*** 中的 ***support*** 变量改为 ***"img/你刚才截图的名字.jpg"***

4. 定义战斗流程（可直接修改 ***fight_ticket_1***，也可自定义函数），具体方式见下
    1. 先实例化一个 ***Fgo_event***
        ```
        fe=Fgo_event()
        ```
    2. 对于每一面（换人面除外），调用一次 ***regular_fight_term*** ，该函数共有两个必须参数
        1. ***skill_list*** ，第一个参数，必须为一个列表，用于指定该面使用的技能，技能编号为1-9(数字)，"master_skill_1", "master_skill_2", "master_skill_3"（字符串）；
            * 如果该技能无需选定对象使用，则用一个技能编号来表示
               ```
               [1,4,9,"master_skill_1"] #使用一号位1技能，二号位1技能，3三号位3技能，御主礼装1技能
               ```
            * 如果该技能需要选定对象使用，则使用一个列表来表示，列表第一个元素为技能编号，第二个元素为适用对象（数字1，2，3）
               ``` 
               [1,[4,1],[7,1],["master_skill_2",1]] #使用一号位1技能，对一号位使用二号位1技能，三号位1技能和御主礼装3技能 
               ```
        2. ***noble_fantasy_list*** ，第二个参数，必须为一个列表，用于指定该面使用的宝具；
           ``` 
           [1,2] #先使用二号位宝具，再使用一号位宝具
           [3,1,2] #按照三号位，一号位，二号位的顺序宝具连携 
           ```
           
        后两个为可选参数
        1. ***wait_cg*** ，第三个参数，必须为一个数字，缺省时为0，该参数决定了使用完宝具后睡眠的时间（秒），用于降低功耗（否则会每0.3s进行一次截图确认是否继续进行）；
        2. ***change*** ，第四个参数，为一个布尔值，缺省时为 ***False*** ，该参数决定了本面是否需要进行换人。换人默认三号位换四号位，并且忽略宝具释放，需要在换人后再调用一次本函数；
            ``` 
            fe.regular_fight_term([8, [9, 1]], [], change=True) # 使用三号位2技能，对一号位使用三号位3技能，三号位换四号位
            fe.regular_fight_term([9], [1], 22)                 # 使用换人后的三号位（原四号位）3技能，使用一号宝具，等待22s再开始查询是否进行下一面操作
            ```
       提供一个demo，为弓凛祭初赛票本脚后跟换人孔明5加成战斗流程，1-4号位分别为 阿克琉斯，斯卡哈·斯卡蒂，斯卡哈·斯卡蒂，诸葛孔明
       ``` 
        fe = Fgo_event()    #创建一个Fgo_event
        fe.regular_fight_term([1, 3, [4, 1], [7, 1]], [1], 20) # 第一面使用阿克琉斯1，3技能，两个斯卡哈·斯卡蒂1技能交阿克琉斯，使用阿克琉斯宝具，等待20s
        fe.regular_fight_term([8, [9, 1]], [], change=True)    # 第二面使用三号位斯卡哈·斯卡蒂2技能并将3技能交阿克琉斯，三号位斯卡哈·斯卡蒂换四号位孔明
        fe.regular_fight_term([9], [1], 22)                    # 第二面换人后使用诸葛孔明3技能，使用阿克琉斯宝具，等待22s
        fe.regular_fight_term([[7, 1], [6, 1], 5], [1], 21)    # 第三面使用诸葛孔明1技能给阿克琉斯，使用斯卡哈·斯卡蒂1技能给阿克琉斯，使用斯卡哈·斯卡蒂2技能，等待21s
       ```
    3. 调用成员函数 ***get_event*** 并返回一个战斗流程
        ``` 
        return fe.get_event()
       ```
     
5. 打开游戏进行设置，取消技能确认，设置好礼装筛选（也可通过 ***support*** 变量来同时筛选助战角色和礼装）
## 使用方式

1. 启动雷电模拟器，设置分辨率为540*960

2. 在任意终端（如cmd）中输入以下命令，会自动在模拟器上安装一个图标为小黄车的app（ATX）

    ```
    adb connect 127.0.0.1:7555
    python -m uiautomator2 init
    ```

3. 在模拟器上打开 ATX(小黄车) ，点击 ***启动 UIAutomator*** 选项，确保 UIAutomator 是运行的。

4. 在模拟器中启动FGO，请确保安装的是国服版本；

5. 打开需要反复战斗的副本的选人界面；

5. 然后在终端中输入

    ```
    cd main.py文件所在的目录（自己复制）
    例如：cd C:\Users\Administrator\Documents\Princess-connection-farm
    ```

5. 再输入以下命令，程序将按顺序自动完成简介中功能1-3。

    ```
    python main.py
    ```

6. 若需要停止脚本，可直接关闭终端或者模拟器（关闭模拟器终端会自动关闭）





